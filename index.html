<!DOCTYPE HTML>
<html lang="fr">

<head>
  <meta charset="utf-8">
  <title>Star Wars SWGOH</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body { background-color: #031952; }
    .unit-card { border: 1px solid #dee2e6; border-radius: 12px; padding: 1rem; background-color: #fff;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); transition: transform 0.2s ease; }
    .unit-card:hover { transform: scale(1.03); border-color: #0d6efd; }
    .unit-img { width: 100px; height: 100px; object-fit: contain; margin-bottom: 1rem; }
    .unit-name { font-size: 0.9em; text-align: center; margin-top: 4px; max-width: 80px; word-wrap: break-word; }
    #scrollToTopBtn { z-index: 10; }
    .formatted-number { white-space: nowrap; }
  </style>
</head>

<body>
  <header class="bg-dark text-white text-center py-4 mb-4">
    <h1>Star Wars Galaxy of Heroes</h1>
    <p>This site uses SWGOH.GG API</p>
    <p>This is a personal site. This site is not affiliated with SWGOH.GG, EA, Capital Games, Disney, Lucasfilm LTD.</p>
  </header>

  <main class="container">

    <section class="card shadow-sm p-4 mb-4">
      <h2 class="mb-3">Connexion</h2>
      <div class="row g-3 align-items-center">
        <div class="col-md-4">
          <input type="text" id="allyCode" class="form-control" placeholder="Ex: 329615792">
        </div>
        <div class="col-auto">
          <button onclick="fetchCharacters()" class="btn btn-primary">Se connecter</button>
        </div>
      </div>
    </section>

    <section id="playerInfo" class="mb-4 d-none">
      <h2 style="color: white;" class="mb-3">Informations du Joueur</h2>
      <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
          <tbody id="playerInfoTable" class="table-group-divider table-hover"></tbody>
        </table>
      </div>
    </section>

    <section class="mb-4 d-flex flex-wrap gap-2">
      <button style="color: white;" class="btn btn-outline-primary" onclick="updateDisplay('characters')">Voir Personnages</button>
      <button style="color: white;" class="btn btn-outline-primary" onclick="updateDisplay('ships')">Voir Vaisseaux</button>
      <button style="color: white;" class="btn btn-outline-secondary" onclick="updateDisplay('all')">Voir Tout</button>
    </section>

    <section class="mb-4">
      <input type="text" id="searchInput" class="form-control" placeholder="Rechercher une unité..." oninput="filterUnits()">
    </section>

    <section id="charactersSection" class="mb-5">
      <h3 style="color: white;" class="mb-3">Personnages</h3>
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4" id="characterList"></div>
    </section>

    <section id="shipsSection" class="mb-5" style="display: none;">
      <h3 style="color: white;" class="mb-3">Vaisseaux</h3>
      <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 g-4" id="shipList"></div>
    </section>

    <button id="scrollToTopBtn" class="btn btn-dark position-fixed bottom-0 end-0 m-3 d-none" onclick="scrollToTop()">↑ Haut</button>
  </main>

  <script>
    function normalizeStat(value) {
      return (value === undefined || value === null || value === "N/A" || isNaN(value)) ? 0 : value;
    }
    function formatNumber(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
    }

    async function fetchCharacters() {
      const allyCode = document.getElementById("allyCode").value.trim().replace(/-/g, "");
      if (!allyCode) return alert("Veuillez entrer un code allié valide !");

      try {
        const response = await fetch(`https://swgoh.gg/api/player/${allyCode}/`);
        if (!response.ok) throw new Error("Erreur HTTP: " + response.status);

        const data = await response.json();
        if (!data || !data.data) return alert("Aucune donnée trouvée pour ce joueur.");

        // On reconstruit comme dans api.php
        const playerData = data.data;
        const units = data.units || [];
        const characters = [];
        const ships = [];

        units.forEach(unit => {
          const u = unit.data;
          const nameFormatted = u.name.toLowerCase()
            .replace(/ /g, "_").replace(/[()]/g, "")
            .replace(/'/g, "-").replace(/"(.*?)"/g, "_$1") + ".png";

          const unitInfo = {
            base_id: u.base_id,
            name: u.name,
            level: u.level,
            rarity: u.rarity,
            power: u.power,
            image: `https://e-rimbault.github.io/swgoh-kit/image-api/${nameFormatted}`,
            gear_level: u.gear_level ?? "N/A",
            relic_tier: u.relic_tier ?? null,
            health: u.stats?.["1"] ?? 0,
            protection: u.stats?.["28"] ?? 0,
            speed: u.stats?.["5"] ?? 0
          };
          if (u.combat_type == 1) characters.push(unitInfo);
          else if (u.combat_type == 2) ships.push(unitInfo);
        });

        characters.sort((a, b) => a.name.localeCompare(b.name));
        ships.sort((a, b) => a.name.localeCompare(b.name));

        const playerInfo = {
          name: playerData.name ?? "Inconnu",
          level: playerData.level ?? "N/A",
          ally_code: playerData.ally_code ?? allyCode,
          guild: playerData.guild_name ?? "Sans guilde",
          gp: playerData.galactic_power ?? 0,
          character_gp: playerData.character_galactic_power ?? 0,
          ship_gp: playerData.ship_galactic_power ?? 0,
          portrait_image: playerData.portrait_image ?? null,
          title: playerData.title ?? null,
          arena: playerData.arena ?? {},
          fleet_arena: playerData.fleet_arena ?? {},
          gac: {
            skill_rating: playerData.skill_rating ?? 0,
            league_name: playerData.league_name ?? "",
            league_image: playerData.league_image ?? "",
            division_number: playerData.division_number ?? "",
            division_image: playerData.division_image ?? ""
          }
        };

        showPlayerInfo(playerInfo);
        displayUnits(characters, "characterList");
        displayUnits(ships, "shipList");
        updateDisplay("all");

      } catch (err) {
        console.error(err);
        alert("Erreur : " + err.message);
      }
    }

    function showPlayerInfo(player) {
      const table = document.getElementById("playerInfoTable");
      document.getElementById("playerInfo").classList.remove("d-none");
      table.innerHTML = `
        <tr><th colspan="2">Informations du Joueur</th></tr>
        <tr><th>Nom</th><td>${player.name}</td></tr>
        <tr><th>Level</th><td>${player.level}</td></tr>
        <tr><th>Code Allié</th><td>${formatNumber(player.ally_code)}</td></tr>
        <tr><th>Guild</th><td>${player.guild}</td></tr>
        <tr><th>Puissance totale</th><td>${formatNumber(player.gp)}</td></tr>
        <tr><th>Puissance persos</th><td>${formatNumber(player.character_gp)}</td></tr>
        <tr><th>Puissance vaisseaux</th><td>${formatNumber(player.ship_gp)}</td></tr>
      `;
    }

    function displayUnits(units, elementId) {
      const container = document.getElementById(elementId);
      container.innerHTML = units.map(unit => `
        <div class="col">
          <div class="unit-card text-center">
            <img src="${unit.image}" alt="${unit.name}" class="unit-img">
            <h5>${unit.name}</h5>
            <p><strong>Level :</strong> ${unit.level}</p>
            <p><strong>⭐ :</strong> ${"⭐".repeat(unit.rarity)}</p>
            <p><strong>Power :</strong> ${formatNumber(unit.power)}</p>
            <p><strong>Gear :</strong> ${unit.gear_level}</p>
          </div>
        </div>
      `).join("");
    }

    function updateDisplay(filter) {
      document.getElementById("charactersSection").style.display = filter === 'characters' || filter === 'all' ? "block" : "none";
      document.getElementById("shipsSection").style.display = filter === 'ships' || filter === 'all' ? "block" : "none";
    }

    function scrollToTop() { window.scrollTo({ top: 0, behavior: "smooth" }); }
    function filterUnits() {
      const q = document.getElementById("searchInput").value.toLowerCase();
      document.querySelectorAll("#characterList .col, #shipList .col").forEach(c => {
        const name = c.querySelector("h5").textContent.toLowerCase();
        c.style.display = name.includes(q) ? "block" : "none";
      });
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
